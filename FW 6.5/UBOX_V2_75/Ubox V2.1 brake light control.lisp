;An example Lisp script for Ubox V2.1's brake light control, with pre-comiled native lib,
;this lib providing PB3, PB4 direct operation
;https://github.com/JohnSpintend/Ubox_FW/tree/main/FW%206.5/UBOX_V2_75

;pre-compiled native lib
(def GPIO-B-3-4 [
0x00 0x00 0x00 0x00 0x10 0xb5 0x14 0x4b 0x14 0x4a 0x12 0x4c 0x14 0x49 0x15 0x48 0x7b 0x44 0x79 0x44
0x9b 0x58 0x78 0x44 0x1b 0x68 0x23 0x68 0x98 0x47 0x12 0x49 0x12 0x48 0x23 0x68 0x79 0x44 0x78 0x44
0x98 0x47 0x11 0x49 0x11 0x48 0x23 0x68 0x79 0x44 0x78 0x44 0x98 0x47 0x10 0x49 0x10 0x48 0x23 0x68
0x79 0x44 0x78 0x44 0x98 0x47 0x0f 0x49 0x0f 0x48 0x23 0x68 0x79 0x44 0x78 0x44 0x98 0x47 0x01 0x20
0x10 0xbd 0x00 0xbf 0x00 0xf8 0x00 0x10 0x74 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0xe3 0x00 0x00 0x00
0x86 0x00 0x00 0x00 0xfd 0x00 0x00 0x00 0x89 0x00 0x00 0x00 0x0d 0x01 0x00 0x00 0x8d 0x00 0x00 0x00
0x1d 0x01 0x00 0x00 0x93 0x00 0x00 0x00 0x2d 0x01 0x00 0x00 0x97 0x00 0x00 0x00 0x00 0x00 0x00 0x00
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
0x65 0x78 0x74 0x2d 0x67 0x70 0x69 0x6f 0x62 0x2d 0x33 0x2d 0x34 0x2d 0x69 0x6e 0x69 0x74 0x00 0x65
0x78 0x74 0x2d 0x73 0x65 0x74 0x2d 0x67 0x70 0x69 0x6f 0x62 0x2d 0x33 0x00 0x65 0x78 0x74 0x2d 0x72
0x65 0x73 0x65 0x74 0x2d 0x67 0x70 0x69 0x6f 0x62 0x2d 0x33 0x00 0x65 0x78 0x74 0x2d 0x73 0x65 0x74
0x2d 0x67 0x70 0x69 0x6f 0x62 0x2d 0x34 0x00 0x65 0x78 0x74 0x2d 0x72 0x65 0x73 0x65 0x74 0x2d 0x67
0x70 0x69 0x6f 0x62 0x2d 0x34 0x00 0x00 0x10 0xb5 0x08 0x4c 0x08 0x48 0xd4 0xf8 0xd0 0x30 0x19 0x22
0x03 0x21 0x98 0x47 0xd4 0xf8 0xd0 0x30 0x04 0x48 0x19 0x22 0x04 0x21 0x98 0x47 0xd4 0xf8 0x8c 0x00
0x10 0xbd 0x00 0xbf 0x00 0xf8 0x00 0x10 0x00 0x04 0x02 0x40 0x10 0xb5 0x04 0x4c 0x04 0x48 0xd4 0xf8
0xd4 0x30 0x03 0x21 0x98 0x47 0xd4 0xf8 0x8c 0x00 0x10 0xbd 0x00 0xf8 0x00 0x10 0x00 0x04 0x02 0x40
0x10 0xb5 0x04 0x4c 0x04 0x48 0xd4 0xf8 0xd8 0x30 0x03 0x21 0x98 0x47 0xd4 0xf8 0x8c 0x00 0x10 0xbd
0x00 0xf8 0x00 0x10 0x00 0x04 0x02 0x40 0x10 0xb5 0x04 0x4c 0x04 0x48 0xd4 0xf8 0xd4 0x30 0x04 0x21
0x98 0x47 0xd4 0xf8 0x8c 0x00 0x10 0xbd 0x00 0xf8 0x00 0x10 0x00 0x04 0x02 0x40 0x10 0xb5 0x04 0x4c
0x04 0x48 0xd4 0xf8 0xd8 0x30 0x04 0x21 0x98 0x47 0xd4 0xf8 0x8c 0x00 0x10 0xbd 0x00 0xf8 0x00 0x10
0x00 0x04 0x02 0x40
])


(load-native-lib GPIO-B-3-4)
; After loading this library we get the extensions:
; (ext-GPIOB-3-4-init)
; (ext-set-GPIOB-3)
; (ext-reset-GPIOB-3)
; (ext-set-GPIOB-4)
; (ext-reset-GPIOB-4)


(def c 0)             ;current
(def brake_state 0)

(ext-GPIOB-3-4-init)
(ext-set-GPIOB-3)   ;front light allways on, brake light will turn on
                    ;when regen current detected

(   loopwhile t
    {
        (setq c (get-current 1))

        (if (= brake_state 1)
            (if (> c -1.0) (setq brake_state 0) )
            (if (< c -2.5) (setq brake_state 1) )
        )

        (if (= brake_state 1)
            (ext-set-GPIOB-4)
            (ext-reset-GPIOB-4)
        )

        (sleep 0.2)

        ;below for test pinout
        ;(ext-GPIOB-3-4-init 0)
        ;(ext-set-gpiob-4)
        ;(sleep 0.5)
        ;(ext-reset-gpiob-4)
        ;(sleep 0.5)
        ;(print "running")
    }
)
